name: Deploy to Hostinger

on:
  push:
    branches:
      - main  # Trigger on push to main branch
  workflow_dispatch:  # Allow manual trigger from GitHub Actions tab

# This workflow will deploy when:
# 1. You push to main branch (especially with "upload to hostinger" in commit message)
# 2. You manually trigger it from GitHub Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v3
        
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: üì• Install dependencies
        run: npm ci --production
        
      - name: ‚úÖ Run tests (optional)
        run: npm test || echo "Tests skipped or failed"
        continue-on-error: true
        
      - name: üì¶ Create deployment package
        run: |
          echo "Creating deployment package..."
          mkdir -p deploy
          
          # Copy all files except excluded ones
          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='.env.*' \
            --exclude='tests' \
            --exclude='.github' \
            --exclude='coverage' \
            --exclude='*.log' \
            --exclude='uploads/*' \
            . deploy/
          
          cd deploy
          
          # Install production dependencies
          npm ci --production --omit=dev
          
          echo "‚úÖ Deployment package created successfully"
          
      - name: üîê Create .env file from secrets
        run: |
          cd deploy
          cat > .env << 'EOF'
          NODE_ENV=production
          PORT=${{ secrets.PORT || '5000' }}
          API_VERSION=v1
          
          # MongoDB Atlas
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          
          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRE=7d
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          JWT_REFRESH_EXPIRE=30d
          
          # Redis
          REDIS_HOST=${{ secrets.REDIS_HOST || 'localhost' }}
          REDIS_PORT=${{ secrets.REDIS_PORT || '6379' }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          # Stripe
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          
          # Email
          EMAIL_HOST=${{ secrets.EMAIL_HOST || 'smtp.gmail.com' }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT || '587' }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          EMAIL_FROM=${{ secrets.EMAIL_FROM }}
          
          # Frontend URL
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          
          # Rate Limiting
          RATE_LIMIT_WINDOW_MS=900000
          RATE_LIMIT_MAX_REQUESTS=100
          
          # File Upload
          MAX_FILE_SIZE=5242880
          ALLOWED_FILE_TYPES=image/jpeg,image/png,image/webp
          EOF
          
          echo "‚úÖ Environment file created"
          
      - name: üöÄ Deploy to Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          exclude: |
            **/.git*
            **/.git*/**
            **/tests/**
            **/coverage/**
            **/*.log
            
      - name: üîÑ Restart Node.js App via SSH
        uses: appleboy/ssh-action@master
        if: secrets.SSH_HOST != ''
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "üîÑ Restarting application..."
            cd ${{ secrets.APP_PATH }}
            
            # Install dependencies if needed
            npm install --production --omit=dev
            
            # Create uploads directory if it doesn't exist
            mkdir -p uploads
            
            # Restart the Node.js app
            # Option 1: Using PM2 (recommended)
            if command -v pm2 &> /dev/null; then
              pm2 restart ecommerce-backend || pm2 start server.js --name ecommerce-backend
              pm2 save
              echo "‚úÖ App restarted with PM2"
            else
              # Option 2: Using Hostinger's Node.js manager
              # You may need to restart manually from Hostinger control panel
              echo "‚ö†Ô∏è PM2 not found. Please restart app from Hostinger control panel"
            fi
            
            echo "‚úÖ Deployment completed successfully!"
            
      - name: üéâ Deployment Success
        run: |
          echo "========================================="
          echo "‚úÖ Deployment to Hostinger completed!"
          echo "========================================="
          echo "Next steps:"
          echo "1. Check your app at your Hostinger URL"
          echo "2. Verify MongoDB Atlas connection"
          echo "3. Test API endpoints"
          echo "========================================="
